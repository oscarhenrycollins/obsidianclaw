var L=Object.defineProperty;var G=Object.getOwnPropertyDescriptor;var F=Object.getOwnPropertyNames;var j=Object.prototype.hasOwnProperty;var z=(g,p)=>{for(var e in p)L(g,e,{get:p[e],enumerable:!0})},_=(g,p,e,t)=>{if(p&&typeof p=="object"||typeof p=="function")for(let s of F(p))!j.call(g,s)&&s!==e&&L(g,s,{get:()=>p[s],enumerable:!(t=G(p,s))||t.enumerable});return g};var W=g=>_(L({},"__esModule",{value:!0}),g);var ee={};z(ee,{default:()=>P});module.exports=W(ee);var u=require("obsidian");function w(g,p=""){return typeof g=="string"?g:p}var U={gatewayUrl:"",token:"",sessionKey:"main",onboardingComplete:!1};function D(g){let p=g.trim();return p.startsWith("https://")?p="wss://"+p.slice(8):p.startsWith("http://")&&(p="ws://"+p.slice(7)),!p.startsWith("ws://")&&!p.startsWith("wss://")?null:p.replace(/\/+$/,"")}function R(g){let p="";for(let e of g)p+=String.fromCharCode(e);return btoa(p).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"")}function q(g){let p=g.replace(/-/g,"+").replace(/_/g,"/")+"=".repeat((4-g.length%4)%4),e=atob(p),t=new Uint8Array(e.length);for(let s=0;s<e.length;s++)t[s]=e.charCodeAt(s);return t}async function Y(g){let p=await crypto.subtle.digest("SHA-256",g.buffer);return Array.from(new Uint8Array(p),e=>e.toString(16).padStart(2,"0")).join("")}async function J(g,p){var h;let e=await g(),t=typeof(e==null?void 0:e.deviceId)=="string"?e.deviceId:null,s=typeof(e==null?void 0:e.devicePublicKey)=="string"?e.devicePublicKey:null,n=typeof(e==null?void 0:e.devicePrivateKey)=="string"?e.devicePrivateKey:null;if(t&&s&&n){let m=q(n),y=await crypto.subtle.importKey("pkcs8",m,{name:"Ed25519"},!1,["sign"]);return{deviceId:t,publicKey:s,privateKey:n,cryptoKey:y}}let i=await crypto.subtle.generateKey("Ed25519",!0,["sign","verify"]),o=new Uint8Array(await crypto.subtle.exportKey("raw",i.publicKey)),a=new Uint8Array(await crypto.subtle.exportKey("pkcs8",i.privateKey)),l=await Y(o),d=R(o),r=R(a),c=(h=await g())!=null?h:{};return c.deviceId=l,c.devicePublicKey=d,c.devicePrivateKey=r,await p(c),{deviceId:l,publicKey:d,privateKey:r,cryptoKey:i.privateKey}}async function X(g,p){let e=new TextEncoder().encode(p),t=g.cryptoKey;if(!t){let n=q(g.privateKey);t=await crypto.subtle.importKey("pkcs8",n,{name:"Ed25519"},!1,["sign"])}let s=await crypto.subtle.sign("Ed25519",t,e);return R(new Uint8Array(s))}function Z(g){var t,s;let p=g.nonce?"v2":"v1",e=[p,g.deviceId,g.clientId,g.clientMode,g.role,g.scopes.join(","),String(g.signedAtMs),(t=g.token)!=null?t:""];return p==="v2"&&e.push((s=g.nonce)!=null?s:""),e.join("|")}function K(){let g=new Uint8Array(16);return crypto.getRandomValues(g),Array.from(g,p=>p.toString(16).padStart(2,"0")).join("")}async function Q(g,p,e=!0){let t=await g.request("sessions.delete",{key:p,deleteTranscript:e});if(t!=null&&t.deleted)return!0;let s=p.match(/^agent:[^:]+:(.+)$/);if(s){let n=s[1],i=await g.request("sessions.delete",{key:n,deleteTranscript:e});return!!(i!=null&&i.deleted)}return!1}var B=class{constructor(p){this.ws=null;this.pending=new Map;this.closed=!1;this.connectSent=!1;this.connectNonce=null;this.backoffMs=800;this.connectTimer=null;this.pendingTimeouts=new Map;this.opts=p}get connected(){var p;return((p=this.ws)==null?void 0:p.readyState)===WebSocket.OPEN}start(){this.closed=!1,this.doConnect()}stop(){var p;this.closed=!0,this.connectTimer!==null&&(clearTimeout(this.connectTimer),this.connectTimer=null);for(let[,e]of this.pendingTimeouts)clearTimeout(e);this.pendingTimeouts.clear(),(p=this.ws)==null||p.close(),this.ws=null,this.flushPending(new Error("client stopped"))}async request(p,e){if(!this.ws||this.ws.readyState!==WebSocket.OPEN)throw new Error("not connected");let t=K(),s={type:"req",id:t,method:p,params:e};return new Promise((n,i)=>{this.pending.set(t,{resolve:n,reject:i});let o=setTimeout(()=>{this.pending.has(t)&&(this.pending.delete(t),i(new Error("request timeout")))},3e4);this.pendingTimeouts.set(t,o),this.ws.send(JSON.stringify(s))})}doConnect(){if(this.closed)return;let p=D(this.opts.url);if(!p){console.error("[ObsidianClaw] Invalid gateway URL: must be a valid ws://, wss://, http://, or https:// URL");return}this.ws=new WebSocket(p),this.ws.addEventListener("open",()=>this.queueConnect()),this.ws.addEventListener("message",e=>this.handleMessage(w(e.data))),this.ws.addEventListener("close",e=>{var t,s;this.ws=null,this.flushPending(new Error(`closed (${e.code})`)),(s=(t=this.opts).onClose)==null||s.call(t,{code:e.code,reason:e.reason||""}),this.scheduleReconnect()}),this.ws.addEventListener("error",()=>{})}scheduleReconnect(){if(this.closed)return;let p=this.backoffMs;this.backoffMs=Math.min(this.backoffMs*1.7,15e3),setTimeout(()=>this.doConnect(),p)}flushPending(p){for(let[e,t]of this.pending){let s=this.pendingTimeouts.get(e);s&&clearTimeout(s),t.reject(p)}this.pending.clear(),this.pendingTimeouts.clear()}queueConnect(){this.connectNonce=null,this.connectSent=!1,this.connectTimer!==null&&clearTimeout(this.connectTimer),this.connectTimer=setTimeout(()=>void this.sendConnect(),750)}async sendConnect(){var l,d;if(this.connectSent)return;this.connectSent=!0,this.connectTimer!==null&&(clearTimeout(this.connectTimer),this.connectTimer=null);let p="gateway-client",e="ui",t="operator",s=["operator.admin","operator.write","operator.read"],n=this.opts.token?{token:this.opts.token}:void 0,i,o=this.opts.deviceIdentity;if(o)try{let r=Date.now(),c=(l=this.connectNonce)!=null?l:null,h=Z({deviceId:o.deviceId,clientId:p,clientMode:e,role:t,scopes:s,signedAtMs:r,token:(d=this.opts.token)!=null?d:null,nonce:c}),m=await X(o,h);i={id:o.deviceId,publicKey:o.publicKey,signature:m,signedAt:r,nonce:c!=null?c:void 0}}catch(r){console.error("[ObsidianClaw] Device signing failed:",r)}let a={minProtocol:3,maxProtocol:3,client:{id:p,version:"0.1.0",platform:"obsidian",mode:e},role:t,scopes:s,auth:n,device:i,caps:["tool-events"]};this.request("connect",a).then(r=>{var c,h;this.backoffMs=800,(h=(c=this.opts).onHello)==null||h.call(c,r)}).catch(()=>{var r;(r=this.ws)==null||r.close(4008,"connect failed")})}handleMessage(p){var t,s,n,i,o;let e;try{e=JSON.parse(p)}catch(a){return}if(e.type==="event"){if(e.event==="connect.challenge"){let a=(t=e.payload)==null?void 0:t.nonce;typeof a=="string"&&(this.connectNonce=a,this.sendConnect());return}(n=(s=this.opts).onEvent)==null||n.call(s,e);return}if(e.type==="res"){let a=this.pending.get(e.id);if(!a)return;this.pending.delete(e.id);let l=this.pendingTimeouts.get(e.id);l&&(clearTimeout(l),this.pendingTimeouts.delete(e.id)),e.ok?a.resolve(e.payload):a.reject(new Error((o=(i=e.error)==null?void 0:i.message)!=null?o:"request failed"))}}},M=class M extends u.Modal{constructor(e,t){super(e);this.step=0;this.path=null;this.statusEl=null;this.pairingPollTimer=null;this.setupKeys={claude1:"",claude2:"",googleai:"",brave:"",elevenlabs:""};this.setupBots=[{name:"Assistant",model:"anthropic/claude-sonnet-4-6"}];this.plugin=t}onOpen(){this.modalEl.addClass("openclaw-onboarding"),this.renderStep()}onClose(){this.pairingPollTimer&&(clearInterval(this.pairingPollTimer),this.pairingPollTimer=null)}setRichText(e,t){var o,a,l,d,r,c;e.empty();let i=new DOMParser().parseFromString(`<span>${t}</span>`,"text/html").body.firstElementChild;if(!i){e.setText(t);return}for(let h of Array.from(i.childNodes))if(h.nodeType===Node.TEXT_NODE)e.appendText((o=h.textContent)!=null?o:"");else if(h instanceof HTMLElement){let m=h.tagName.toLowerCase();m==="a"?e.createEl("a",{text:(a=h.textContent)!=null?a:"",href:(l=h.getAttribute("href"))!=null?l:""}):m==="code"?e.createEl("code",{text:(d=h.textContent)!=null?d:""}):m==="strong"?e.createEl("strong",{text:(r=h.textContent)!=null?r:""}):e.appendText((c=h.textContent)!=null?c:"")}}renderStep(){let{contentEl:e}=this;e.empty(),this.statusEl=null;let t=this.path==="fresh"?["Start","Keys","Bots","Install","Connect","Pair","Done"]:this.path==="existing"?["Start","Network","Gateway","Connect","Pair","Done"]:["Start"],s=e.createDiv("openclaw-onboard-steps");if(t.forEach((n,i)=>{let o=s.createSpan("openclaw-step-dot"+(i===this.step?" active":i<this.step?" done":""));o.textContent=i<this.step?"\u2713":String(i+1),i<t.length-1&&s.createSpan("openclaw-step-line"+(i<this.step?" done":""))}),this.step===0)return this.renderWelcome(e);if(this.path==="fresh"){if(this.step===1)return this.renderKeys(e);if(this.step===2)return this.renderBots(e);if(this.step===3)return this.renderInstallCmd(e);if(this.step===4)return this.renderConnect(e);if(this.step===5)return this.renderPairing(e);if(this.step===6)return this.renderDone(e)}else{if(this.step===1)return this.renderNetwork(e);if(this.step===2)return this.renderGateway(e);if(this.step===3)return this.renderConnect(e);if(this.step===4)return this.renderPairing(e);if(this.step===5)return this.renderDone(e)}}renderWelcome(e){e.createEl("h2",{text:"Welcome to OpenClaw"}),e.createEl("p",{text:"This plugin connects Obsidian to your OpenClaw AI agent. Your vault becomes the agent's workspace.",cls:"openclaw-onboard-desc"});let t=e.createDiv("openclaw-onboard-buttons openclaw-onboard-buttons-vertical");t.createEl("button",{text:"I need to install OpenClaw",cls:"mod-cta openclaw-full-width"}).addEventListener("click",()=>{this.path="fresh",this.step=1,this.renderStep()}),t.createEl("button",{text:"OpenClaw is already running",cls:"openclaw-full-width"}).addEventListener("click",()=>{this.path="existing",this.step=1,this.renderStep()})}renderKeys(e){e.createEl("h2",{text:"Your API keys"}),e.createEl("p",{text:"Your bot needs AI model access. Paste your keys below \u2014 they'll be included in the install command. Nothing leaves your device.",cls:"openclaw-onboard-desc"});let t=[{key:"claude1",label:"Claude token",required:!0,placeholder:"sk-ant-...",help:"From <a href='https://console.anthropic.com/settings/keys'>console.anthropic.com</a> or Claude Max OAuth"},{key:"claude2",label:"Claude token #2 (parallel requests)",placeholder:"sk-ant-...",help:"Optional \u2014 enables concurrent requests"},{key:"googleai",label:"Google AI API key",placeholder:"AIza...",help:"Free at <a href='https://aistudio.google.com/apikey'>aistudio.google.com</a> \u2014 enables Gemini models"},{key:"brave",label:"Brave Search API key",placeholder:"BSA...",help:"Free at <a href='https://brave.com/search/api/'>brave.com/search/api</a> \u2014 web search"},{key:"elevenlabs",label:"ElevenLabs API key",placeholder:"sk_...",help:"Free at <a href='https://elevenlabs.io'>elevenlabs.io</a> \u2014 voice/TTS"}];for(let o of t){let a=e.createDiv("openclaw-onboard-field"),l=a.createEl("label",{text:o.label});if(o.required){let c=l.createSpan({cls:"oc-req-label"});c.textContent=" (required)"}let d=a.createEl("input",{type:"password",value:this.setupKeys[o.key],placeholder:o.placeholder,cls:"openclaw-onboard-input"});d.addEventListener("input",()=>{this.setupKeys[o.key]=d.value.trim()});let r=a.createDiv("openclaw-onboard-hint");this.setRichText(r,o.help)}e.createDiv("openclaw-onboard-info").setText("\u{1F512} Keys stay on your device. The install command runs entirely on your server."),this.statusEl=e.createDiv("openclaw-onboard-status");let n=e.createDiv("openclaw-onboard-buttons");n.createEl("button",{text:"\u2190 back"}).addEventListener("click",()=>{this.step=0,this.path=null,this.renderStep()}),n.createEl("button",{text:"Next \u2192",cls:"mod-cta"}).addEventListener("click",()=>{if(!this.setupKeys.claude1){this.showStatus("Claude token is required","error");return}this.step=2,this.renderStep()})}renderBots(e){e.createEl("h2",{text:"Configure your bots"}),e.createEl("p",{text:"Each bot gets its own personality, memory, and workspace folder.",cls:"openclaw-onboard-desc"});let t=e.createDiv();this.setupBots.forEach((a,l)=>{let r=t.createDiv("openclaw-onboard-bot-card").createDiv("openclaw-onboard-bot-row"),c=r.createEl("input",{type:"text",value:a.name,placeholder:"Bot name",cls:"openclaw-onboard-input oc-name-input"});c.addEventListener("input",()=>{a.name=c.value});let h=r.createEl("select",{cls:"openclaw-onboard-input oc-select-inline"});for(let m of M.MODELS){let y=h.createEl("option",{text:m.label,value:m.id});m.id===a.model&&(y.selected=!0)}h.addEventListener("change",()=>{a.model=h.value}),this.setupBots.length>1&&r.createEl("span",{text:"\xD7",cls:"oc-remove-btn"}).addEventListener("click",()=>{this.setupBots.splice(l,1),this.renderStep()})}),e.createEl("button",{text:"+ add another bot",cls:"oc-add-bot-btn"}).addEventListener("click",()=>{this.setupBots.push({name:"",model:"anthropic/claude-sonnet-4-6"}),this.renderStep()});let n=e.createDiv("openclaw-onboard-hint oc-margin-top");n.createEl("span",{text:"Each bot gets a folder like "}),n.createEl("code",{text:"AGENT-YOURBOT/"}),n.createEl("span",{text:" in your vault."}),this.statusEl=e.createDiv("openclaw-onboard-status");let i=e.createDiv("openclaw-onboard-buttons");i.createEl("button",{text:"\u2190 back"}).addEventListener("click",()=>{this.step=1,this.renderStep()}),i.createEl("button",{text:"Generate install command \u2192",cls:"mod-cta"}).addEventListener("click",()=>{this.step=3,this.renderStep()})}renderInstallCmd(e){e.createEl("h2",{text:"Install OpenClaw"}),e.createEl("p",{text:"Open a terminal on your server (Mac: Cmd+Space \u2192 Terminal, cloud: ssh in). Run this command:",cls:"openclaw-onboard-desc"});let t=this.generateConfig(),s=JSON.stringify(t,null,2),i=`curl -fsSL https://openclaw.ai/install.sh | bash && echo '${btoa(Array.from(new TextEncoder().encode(s),r=>String.fromCharCode(r)).join(""))}' | base64 -d > ~/.openclaw/openclaw.json && openclaw gateway restart`;this.makeCopyBox(e,i),e.createEl("p",{text:"This installs OpenClaw, writes your config with all API keys and bot settings, configures Tailscale Serve, and starts the gateway.",cls:"openclaw-onboard-hint"});let o=e.createEl("details",{cls:"oc-margin-top"});o.createEl("summary",{text:"Preview config",cls:"oc-details-summary"});let a=o.createEl("pre",{cls:"oc-install-pre"});a.textContent=JSON.stringify(t,null,2),e.createEl("p",{text:"After it finishes, install Tailscale if you haven't:",cls:"openclaw-onboard-desc"}),this.makeCopyBox(e,`# Mac:
brew install --cask tailscale

# Linux:
curl -fsSL https://tailscale.com/install.sh | sh && sudo tailscale up`),e.createEl("p",{text:"Then install Tailscale on this device too, using the same account.",cls:"openclaw-onboard-hint"}),this.statusEl=e.createDiv("openclaw-onboard-status");let l=e.createDiv("openclaw-onboard-buttons");l.createEl("button",{text:"\u2190 back"}).addEventListener("click",()=>{this.step=2,this.renderStep()}),l.createEl("button",{text:"OpenClaw is running \u2192",cls:"mod-cta"}).addEventListener("click",()=>{this.step=4,this.renderStep()})}generateConfig(){var t,s;let e={auth:{profiles:{}},agents:{defaults:{model:{primary:((t=this.setupBots[0])==null?void 0:t.model)||"anthropic/claude-sonnet-4-6"}}},gateway:{port:18789,bind:"loopback",tailscale:{mode:"serve"},auth:{mode:"token",allowTailscale:!0}}};if(this.setupKeys.claude1&&(e.auth.profiles["anthropic:default"]={provider:"anthropic",mode:"token"}),this.setupKeys.claude2&&(e.auth.profiles["anthropic:secondary"]={provider:"anthropic",mode:"token"}),this.setupKeys.googleai&&(e.auth.profiles["google:default"]={provider:"google",mode:"api_key"}),this.setupKeys.brave&&(e.tools={web:{search:{apiKey:this.setupKeys.brave}}}),this.setupKeys.elevenlabs&&(e.messages={tts:{provider:"elevenlabs",elevenlabs:{apiKey:this.setupKeys.elevenlabs}}}),this.setupBots.length>1)e.agents.list=this.setupBots.map((n,i)=>{let o=i===0?"main":n.name.toLowerCase().replace(/[^a-z0-9]/g,"-")||`bot-${i}`,a="AGENT-"+(n.name||"BOT").toUpperCase().replace(/[^A-Z0-9]/g,"-");return{id:o,name:n.name||`Bot ${i+1}`,workspace:`~/.openclaw/workspace/${a}`}});else if((s=this.setupBots[0])!=null&&s.name){let n="AGENT-"+this.setupBots[0].name.toUpperCase().replace(/[^A-Z0-9]/g,"-");e.agents.defaults.workspace=`~/.openclaw/workspace/${n}`}return e}renderNetwork(e){e.createEl("h2",{text:"Set up your private network"}),e.createEl("p",{text:"Tailscale creates an encrypted private network between your devices. No ports to open, no VPN to configure.",cls:"openclaw-onboard-desc"}),e.createEl("h3",{text:"Install Tailscale on both devices"});let t=e.createEl("ol",{cls:"openclaw-onboard-list"}),s=t.createEl("li");s.appendText("Install on your "),s.createEl("strong",{text:"gateway machine"}),s.appendText(": "),s.createEl("a",{text:"tailscale.com/download",href:"https://tailscale.com/download"});let n=t.createEl("li");n.appendText("Install on "),n.createEl("strong",{text:"this device"}),n.appendText(": "),n.createEl("a",{text:"tailscale.com/download",href:"https://tailscale.com/download"}),t.createEl("li",{text:"Sign in to the same Tailscale account on both."}),e.createEl("p",{text:"Verify by running this on the gateway:",cls:"openclaw-onboard-hint"}),this.makeCopyBox(e,"tailscale status"),this.statusEl=e.createDiv("openclaw-onboard-status");let i=e.createDiv("openclaw-onboard-buttons");i.createEl("button",{text:"\u2190 back"}).addEventListener("click",()=>{this.step=0,this.path=null,this.renderStep()}),i.createEl("button",{text:"Both on Tailscale \u2192",cls:"mod-cta"}).addEventListener("click",()=>{this.step=2,this.renderStep()})}renderGateway(e){e.createEl("h2",{text:"Expose your gateway"}),e.createEl("p",{text:"Tailscale Serve gives your gateway a private HTTPS address. Run on the gateway machine:",cls:"openclaw-onboard-desc"}),e.createEl("strong",{text:"1. Configure OpenClaw"}),this.makeCopyBox(e,`openclaw config set gateway.bind loopback
openclaw config set gateway.tailscale.mode serve
openclaw gateway restart`),e.createEl("strong",{text:"2. Start Tailscale serve"}),this.makeCopyBox(e,"tailscale serve --bg http://127.0.0.1:18789"),e.createEl("strong",{text:"3. Get your URL and token"}),this.makeCopyBox(e,"tailscale serve status"),this.makeCopyBox(e,"cat ~/.openclaw/openclaw.json | grep token");let t=e.createDiv("openclaw-onboard-hint");t.appendText("Copy the "),t.createEl("code",{text:"https://your-machine.tailXXXX.ts.net"}),t.appendText(" URL and the auth token for the next step.");let s=e.createDiv("openclaw-onboard-info");s.appendText("\u{1F4A1} "),s.createEl("strong",{text:"Not working?"}),s.appendText(" Run: "),this.makeCopyBox(s,"openclaw doctor --fix && openclaw gateway restart"),this.statusEl=e.createDiv("openclaw-onboard-status");let n=e.createDiv("openclaw-onboard-buttons");n.createEl("button",{text:"\u2190 back"}).addEventListener("click",()=>{this.step=1,this.renderStep()}),n.createEl("button",{text:"I have the URL and token \u2192",cls:"mod-cta"}).addEventListener("click",()=>{this.step=3,this.renderStep()})}renderConnect(e){e.createEl("h2",{text:"Connect to your gateway"}),e.createEl("p",{text:"Paste the URL and token from the previous step.",cls:"openclaw-onboard-desc"});let t=e.createDiv("openclaw-onboard-field");t.createEl("label",{text:"Gateway URL"});let s=t.createEl("input",{type:"text",value:this.plugin.settings.gatewayUrl||"",placeholder:"https://your-machine.tail1234.ts.net",cls:"openclaw-onboard-input"}),n=t.createDiv("openclaw-onboard-hint");n.appendText("The URL from "),n.createEl("code",{text:"tailscale serve status"}),n.appendText(". You can paste "),n.createEl("code",{text:"https://"}),n.appendText(" or "),n.createEl("code",{text:"wss://"}),n.appendText(" \u2014 both work.");let i=e.createDiv("openclaw-onboard-field");i.createEl("label",{text:"Auth token"});let o=i.createEl("input",{type:"password",value:this.plugin.settings.token||"",placeholder:"Paste your gateway auth token",cls:"openclaw-onboard-input"});this.statusEl=e.createDiv("openclaw-onboard-status");let a=e.createDiv("openclaw-onboard-troubleshoot");a.addClass("oc-hidden"),a.createEl("h3",{text:"Troubleshooting"});let l=a.createEl("ol",{cls:"openclaw-onboard-list"}),d=l.createEl("li");d.createEl("strong",{text:"Is Tailscale connected on this device?"}),d.appendText(" Check the Tailscale icon in your system tray / menu bar. If it's off, turn it on.");let r=l.createEl("li");r.createEl("strong",{text:"DNS not resolving? (most common on macOS)"}),r.appendText(" Open the "),r.createEl("strong",{text:"Tailscale app"}),r.appendText(" from your menu bar, toggle it "),r.createEl("strong",{text:"OFF"}),r.appendText(", wait 5 seconds, toggle it "),r.createEl("strong",{text:"ON"}),r.appendText(". This resets MagicDNS, which macOS sometimes loses track of."),l.createEl("li").setText("Is the gateway running? On the gateway machine, run:"),this.makeCopyBox(a,"openclaw doctor --fix && openclaw gateway restart"),l.createEl("li").setText("Is Tailscale Serve active? On the gateway machine, run:"),this.makeCopyBox(a,"tailscale serve status"),a.createDiv("openclaw-onboard-hint").setText("If Tailscale Serve shows nothing, set it up:"),this.makeCopyBox(a,"tailscale serve --bg http://127.0.0.1:18789");let y=l.createEl("li");y.createEl("strong",{text:"Gateway config broken?"}),y.appendText(" If "),y.createEl("code",{text:"openclaw doctor"}),y.appendText(' shows "Invalid config" errors, your gateway config file may have been corrupted. To reset to the recommended setup, run these on the gateway machine:'),this.makeCopyBox(a,`cat ~/.openclaw/openclaw.json | python3 -c "
import json, sys
c = json.load(sys.stdin)
c.setdefault('gateway', {})['bind'] = 'loopback'
c['gateway'].setdefault('tailscale', {})['mode'] = 'serve'
c['gateway']['tailscale']['resetOnExit'] = False
json.dump(c, open(sys.argv[1], 'w'), indent=2)
print('Config fixed: bind=loopback, tailscale.mode=serve')
" ~/.openclaw/openclaw.json`),a.createDiv("openclaw-onboard-hint").setText("Then restart the gateway and re-enable Tailscale Serve:"),this.makeCopyBox(a,"openclaw gateway restart && tailscale serve --bg http://127.0.0.1:18789");let k=l.createEl("li");k.createEl("strong",{text:"Still stuck?"}),k.appendText(" Try restarting the Tailscale app entirely, or reboot this device. macOS DNS can get stuck and needs a fresh start.");let E=e.createDiv("openclaw-onboard-buttons");E.createEl("button",{text:"\u2190 back"}).addEventListener("click",()=>{this.step=2,this.renderStep()});let v=E.createEl("button",{text:"Test connection",cls:"mod-cta"});v.addEventListener("click",()=>void(async()=>{let I=s.value.trim(),T=o.value.trim();if(!I){this.showStatus("Paste your gateway URL from the previous step","error");return}let x=D(I);if(!x){this.showStatus("That doesn't look right. Paste the URL from `tailscale serve status` (e.g. https://your-machine.tail1234.ts.net)","error");return}if(!T){this.showStatus("Paste your auth token","error");return}v.disabled=!0,v.textContent="Connecting...",a.addClass("oc-hidden"),this.showStatus("Testing connection...","info"),s.value=x,this.plugin.settings.gatewayUrl=x,this.plugin.settings.token=T,this.plugin.settings.sessionKey="main",await this.plugin.saveSettings();let b=await new Promise(N=>{let V=setTimeout(()=>{A.stop(),N(!1)},8e3),A=new B({url:x,token:T,onHello:()=>{clearTimeout(V),A.stop(),N(!0)},onClose:()=>{}});A.start()});v.disabled=!1,v.textContent="Test connection",b?(this.showStatus("\u2713 Connected!","success"),setTimeout(()=>{this.step=4,this.renderStep()},800)):(this.showStatus("Could not connect. Check the troubleshooting steps below.","error"),a.removeClass("oc-hidden"))})())}makeCopyBox(e,t){let s=e.createDiv("openclaw-copy-box");s.createEl("code",{text:t});let n=s.createSpan("openclaw-copy-btn");return n.textContent="Copy",s.addEventListener("click",()=>{navigator.clipboard.writeText(t).then(()=>{n.textContent="\u2713",setTimeout(()=>n.textContent="Copy",1500)})}),s}renderPairing(e){var d,r;e.createEl("h2",{text:"Pair this device"}),e.createEl("p",{text:"For security, each device needs one-time approval from the gateway. This creates a unique keypair for this device so the gateway knows it's you.",cls:"openclaw-onboard-desc"});let t=this.plugin.settings.deviceId&&this.plugin.settings.devicePublicKey;if(t){let c=e.createDiv("openclaw-onboard-info");c.createEl("p",{text:"This device already has a keypair."});let h=c.createEl("p");h.appendText("Device ID: "),h.createEl("code",{text:((r=(d=this.plugin.settings.deviceId)==null?void 0:d.slice(0,12))!=null?r:"")+"..."})}this.statusEl=e.createDiv("openclaw-onboard-status");let n=e.createDiv("openclaw-onboard-numbered").createDiv("openclaw-onboard-numbered-item");n.createEl("strong",{text:"How approval works"}),n.createEl("p",{text:"Click the button below to send a pairing request. Then, on your gateway machine, run:",cls:"openclaw-onboard-hint"}),this.makeCopyBox(n,"openclaw devices list"),n.createEl("p",{text:"You'll see your pending request. Approve it with:",cls:"openclaw-onboard-hint"}),this.makeCopyBox(n,"openclaw devices approve <requestId>");let i=n.createEl("p",{cls:"openclaw-onboard-hint"});i.appendText("Replace "),i.createEl("code",{text:"<requestId>"}),i.appendText(" with the ID shown in the pending list. You can also approve from the OpenClaw Control UI dashboard.");let o=e.createDiv("openclaw-onboard-buttons");o.createEl("button",{text:"\u2190 back"}).addEventListener("click",()=>{this.step=3,this.renderStep()});let a=o.createEl("button",{text:t?"Check pairing status":"Send pairing request",cls:"mod-cta"});a.addEventListener("click",()=>void(async()=>{a.disabled=!0,this.showStatus("Connecting to gateway...","info");try{if(await this.plugin.connectGateway(),await new Promise(c=>setTimeout(c,2e3)),!this.plugin.gatewayConnected){this.showStatus("Could not connect to gateway. Go back and check your settings.","error"),a.disabled=!1;return}try{let c=await this.plugin.gateway.request("sessions.list",{});if(c!=null&&c.sessions){this.showStatus("\u2713 Device is paired and authorized!","success"),setTimeout(()=>{this.step=5,this.renderStep()},1e3);return}}catch(c){let h=String(c);if(h.includes("scope")||h.includes("auth")||h.includes("pair")){this.showStatus(`\u23F3 Pairing request sent! Now approve it on your gateway machine using the commands above.

Waiting for approval...`,"info"),this.startPairingPoll(a);return}}this.showStatus("\u2713 Connection working! Proceeding...","success"),setTimeout(()=>{this.step=5,this.renderStep()},1e3)}catch(c){this.showStatus(`Error: ${c}`,"error"),a.disabled=!1}})()),o.createEl("button",{text:"Skip for now"}).addEventListener("click",()=>{this.step=5,this.renderStep()})}startPairingPoll(e){let t=0;this.pairingPollTimer=setInterval(()=>void(async()=>{var s;if(t++,t>60){this.pairingPollTimer&&clearInterval(this.pairingPollTimer),this.showStatus("Timed out waiting for approval. You can approve later and re-run the setup wizard from settings.","error"),e.disabled=!1;return}try{let n=await((s=this.plugin.gateway)==null?void 0:s.request("sessions.list",{}));n!=null&&n.sessions&&(this.pairingPollTimer&&clearInterval(this.pairingPollTimer),this.showStatus("\u2713 Device approved!","success"),setTimeout(()=>{this.step=5,this.renderStep()},1e3))}catch(n){}})(),2e3)}renderDone(e){e.createEl("h2",{text:"You're all set! \u{1F389}"}),e.createEl("p",{text:"OpenClaw is connected and ready. Your vault is now the agent's workspace.",cls:"openclaw-onboard-desc"});let t=e.createDiv("openclaw-onboard-tips");t.createEl("h3",{text:"What you can do"});let s=t.createEl("ul",{cls:"openclaw-onboard-list"});s.createEl("li",{text:"Chat with your AI agent in the sidebar"}),s.createEl("li",{text:'Use Cmd/Ctrl+P \u2192 "Ask about current note" to discuss any note'}),s.createEl("li",{text:"The agent can read, create, and edit files in your vault"}),s.createEl("li",{text:"Tool calls appear inline \u2014 click file paths to open them"});let n=e.createDiv("openclaw-onboard-info");n.createEl("strong",{text:"\u{1F4A1} sync tip: "}),n.createEl("span",{text:"Enable Obsidian Sync to access your agent from multiple devices. Your chat settings and device keys sync automatically \u2014 set up once, works everywhere."});let i=e.createDiv("openclaw-onboard-info");i.createEl("strong",{text:"\u{1F5A5}\uFE0F control UI: "}),i.createEl("span").setText("You can also manage your gateway from any browser on your Tailscale network. Just open your gateway URL in a browser."),e.createDiv("openclaw-onboard-buttons").createEl("button",{text:"Start chatting \u2192",cls:"mod-cta"}).addEventListener("click",()=>void(async()=>{this.plugin.settings.onboardingComplete=!0,this.plugin.settings.sessionKey="main",await this.plugin.saveSettings(),this.close(),this.plugin.gatewayConnected||this.plugin.connectGateway(),this.plugin.activateView()})())}showStatus(e,t){if(this.statusEl){this.statusEl.empty(),this.statusEl.className=`openclaw-onboard-status openclaw-onboard-status-${t}`;for(let s of e.split(`
`))this.statusEl.childNodes.length>0&&this.statusEl.createEl("br"),this.statusEl.appendText(s)}}};M.MODELS=[{id:"anthropic/claude-opus-4-6",label:"Claude Opus 4"},{id:"anthropic/claude-sonnet-4-6",label:"Claude Sonnet 4"},{id:"anthropic/claude-sonnet-4-5",label:"Claude Sonnet 4.5"},{id:"google/gemini-2.5-pro",label:"Gemini 2.5 Pro"},{id:"google/gemini-2.5-flash",label:"Gemini 2.5 Flash"}];var C=M,S="openclaw-chat",$=class extends u.ItemView{constructor(e,t){super(e);this.tabSessions=[];this.renderingTabs=!1;this.tabDeleteInProgress=!1;this.messages=[];this.streams=new Map;this.runToSession=new Map;this.streamEl=null;this.currentModel="";this.currentModelSetAt=0;this.cachedSessionDisplayName="";this.agents=[];this.activeAgent={id:"main",name:"Agent",emoji:"\u{1F916}",creature:""};this.profileBtnEl=null;this.profileDropdownEl=null;this.pendingAttachments=[];this.sending=!1;this.recording=!1;this.mediaRecorder=null;this.recordedChunks=[];this.micSvg='<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>';this.sendSvg='<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>';this.stopSvg='<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="red" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/></svg>';this.plugin=t}get activeSessionKey(){return this.plugin.settings.sessionKey||"main"}get activeStream(){var e;return(e=this.streams.get(this.activeSessionKey))!=null?e:null}get agentPrefix(){return`agent:${this.activeAgent.id}:`}getViewType(){return S}getDisplayText(){return"OpenClaw"}getIcon(){return"message-square"}async onOpen(){let e=this.containerEl.children[1];e.empty(),e.addClass("openclaw-chat-container");let t=e.createDiv("openclaw-top-bar");this.tabBarEl=t.createDiv("openclaw-tab-bar"),this.tabBarEl.addEventListener("wheel",r=>{r.preventDefault(),this.tabBarEl.scrollLeft+=r.deltaY},{passive:!1}),this.profileBtnEl=t.createDiv("openclaw-agent-btn"),this.profileBtnEl.setAttribute("aria-label","Switch agent"),this.updateAgentButton(),this.profileBtnEl.addEventListener("click",r=>{r.stopPropagation(),this.toggleAgentSwitcher()}),this.profileDropdownEl=e.createDiv("openclaw-agent-dropdown"),this.profileDropdownEl.addClass("oc-hidden"),document.addEventListener("click",()=>{this.profileDropdownEl&&this.profileDropdownEl.addClass("oc-hidden")}),this.renderTabs(),this.contextMeterEl=createDiv(),this.contextFillEl=createDiv(),this.contextLabelEl=document.createElement("span"),this.modelLabelEl=createDiv(),this.bannerEl=e.createDiv("openclaw-banner"),this.bannerEl.addClass("oc-hidden"),this.messagesEl=e.createDiv("openclaw-messages"),this.typingEl=e.createDiv("openclaw-typing"),this.typingEl.addClass("oc-hidden");let s=this.typingEl.createDiv("openclaw-typing-inner");s.createSpan({text:"Thinking",cls:"openclaw-typing-text"});let n=s.createSpan("openclaw-typing-dots");n.createSpan("openclaw-dot"),n.createSpan("openclaw-dot"),n.createSpan("openclaw-dot");let i=e.createDiv("openclaw-input-area"),o=i.createDiv("openclaw-input-row"),a=o.createEl("button",{cls:"openclaw-brain-btn",attr:{"aria-label":"Switch model"}});(0,u.setIcon)(a,"brain"),a.addEventListener("click",()=>this.openModelPicker());let l=o.createEl("button",{cls:"openclaw-attach-btn",attr:{"aria-label":"Attach file"}});(0,u.setIcon)(l,"paperclip"),this.fileInputEl=i.createEl("input",{cls:"openclaw-file-input",attr:{type:"file",accept:"image/*,.md,.txt,.json,.csv,.pdf,.yaml,.yml,.js,.ts,.py,.html,.css",multiple:"true"}}),this.fileInputEl.addClass("oc-hidden"),this.fileInputEl.addEventListener("change",()=>void this.handleFileSelect()),l.addEventListener("click",()=>this.fileInputEl.click()),this.inputEl=o.createEl("textarea",{cls:"openclaw-input",attr:{placeholder:"Message...",rows:"1"}}),this.attachPreviewEl=i.createDiv("openclaw-attach-preview"),this.attachPreviewEl.addClass("oc-hidden"),this.abortBtn=o.createEl("button",{cls:"openclaw-abort-btn",attr:{"aria-label":"Stop"}}),(0,u.setIcon)(this.abortBtn,"square"),this.abortBtn.addClass("oc-hidden");let d=o.createDiv("openclaw-send-wrapper");this.sendBtn=d.createEl("button",{cls:"openclaw-send-btn",attr:{"aria-label":"Send"}}),(0,u.setIcon)(this.sendBtn,"send"),this.sendBtn.addClass("oc-opacity-low"),this.reconnectBtn=d.createEl("button",{cls:"openclaw-reconnect-btn",attr:{"aria-label":"Reconnect"}}),(0,u.setIcon)(this.reconnectBtn,"refresh-cw"),this.reconnectBtn.addClass("oc-hidden"),this.reconnectBtn.addEventListener("click",()=>{this.plugin.connectGateway()}),this.statusEl=d.createSpan("openclaw-status-dot"),this.inputEl.addEventListener("keydown",r=>{if(r.key==="Enter"){if(u.Platform.isMobile)return;r.shiftKey||(r.preventDefault(),this.sendMessage())}}),this.inputEl.addEventListener("input",()=>{this.autoResize(),this.updateSendButton()}),this.inputEl.addEventListener("focus",()=>{setTimeout(()=>{this.inputEl.scrollIntoView({block:"end",behavior:"smooth"})},300)}),this.inputEl.addEventListener("paste",r=>{var h;let c=(h=r.clipboardData)==null?void 0:h.items;if(c){for(let m of Array.from(c))if(m.type.startsWith("image/")){r.preventDefault();let y=m.getAsFile();y&&this.handlePastedFile(y);return}}}),this.sendBtn.addEventListener("click",()=>{(this.inputEl.value.trim()||this.pendingAttachments.length>0)&&this.sendMessage()}),this.abortBtn.addEventListener("click",()=>void this.abortMessage()),this.updateStatus(),this.plugin.chatView=this,this.plugin.gatewayConnected&&(await this.loadHistory(),this.loadAgents())}onClose(){this.plugin.chatView===this&&(this.plugin.chatView=null)}updateStatus(){if(!this.statusEl)return;this.statusEl.removeClass("connected","disconnected");let e=this.plugin.gatewayConnected;this.statusEl.addClass(e?"connected":"disconnected"),e?(this.sendBtn.removeClass("oc-hidden"),this.reconnectBtn&&this.reconnectBtn.addClass("oc-hidden"),this.inputEl.disabled=!1,this.inputEl.placeholder="Message..."):(this.sendBtn.addClass("oc-hidden"),this.reconnectBtn&&this.reconnectBtn.removeClass("oc-hidden"),this.inputEl.disabled=!0,this.inputEl.placeholder="Disconnected")}async loadAgents(){var e;if((e=this.plugin.gateway)!=null&&e.connected)try{let t=await this.plugin.gateway.request("agents.list",{}),s=(t==null?void 0:t.agents)||[];s.length===0&&s.push({id:"main"});let n=[];for(let a of s)n.push({id:a.id||"main",name:a.name||a.id||"Agent",emoji:"\u{1F916}",creature:""});this.agents=n;let i=this.plugin.settings.activeAgentId,o=n.find(a=>a.id===i)||n[0];o&&(this.activeAgent=o,this.plugin.settings.activeAgentId!==o.id&&(this.plugin.settings.activeAgentId=o.id,await this.plugin.saveSettings())),this.updateAgentButton()}catch(t){console.warn("[ObsidianClaw] Failed to load agents:",t)}}updateAgentButton(){if(!this.profileBtnEl)return;if(this.agents.length<=1){this.profileBtnEl.addClass("oc-hidden");return}this.profileBtnEl.removeClass("oc-hidden");let e=this.activeAgent.emoji||"\u{1F916}";this.profileBtnEl.empty(),this.profileBtnEl.createSpan({text:e,cls:"openclaw-agent-emoji"})}async switchAgent(e){e.id!==this.activeAgent.id&&(this.activeAgent=e,this.plugin.settings.activeAgentId=e.id,this.plugin.settings.sessionKey="main",await this.plugin.saveSettings(),this.updateAgentButton(),await this.loadHistory(),await this.renderTabs())}toggleAgentSwitcher(){if(!this.profileDropdownEl)return;if(!this.profileDropdownEl.hasClass("oc-hidden")){this.profileDropdownEl.addClass("oc-hidden");return}this.profileDropdownEl.empty();for(let t of this.agents){let s=t.id===this.activeAgent.id,n=this.profileDropdownEl.createDiv({cls:`openclaw-agent-item${s?" active":""}`});n.createSpan({text:t.emoji||"\u{1F916}",cls:"openclaw-agent-item-emoji"});let i=n.createDiv("openclaw-agent-item-info");i.createDiv({text:t.name,cls:"openclaw-agent-item-name"}),t.creature&&i.createDiv({text:t.creature,cls:"openclaw-agent-item-sub"}),s||n.addEventListener("click",()=>{this.profileDropdownEl.addClass("oc-hidden"),this.switchAgent(t)})}this.profileDropdownEl.removeClass("oc-hidden")}async loadHistory(){var e;if((e=this.plugin.gateway)!=null&&e.connected)try{let t=await this.plugin.gateway.request("chat.history",{sessionKey:this.plugin.settings.sessionKey,limit:200});t!=null&&t.messages&&Array.isArray(t.messages)&&(this.messages=t.messages.filter(s=>s.role==="user"||s.role==="assistant").map(s=>{var o;let{text:n,images:i}=this.extractContent(s.content);return{role:s.role,text:n,images:i,timestamp:(o=s.timestamp)!=null?o:Date.now(),contentBlocks:Array.isArray(s.content)?s.content:void 0}}).filter(s=>(s.text.trim()||s.images.length>0)&&!s.text.startsWith("HEARTBEAT")),this.messages.length>0&&this.messages[0].role==="user"&&(this.messages=this.messages.slice(1)),await this.renderMessages(),this.updateContextMeter())}catch(t){console.error("[ObsidianClaw] Failed to load history:",t)}}extractContent(e){var a;let t="",s=[];if(typeof e=="string")t=e;else if(Array.isArray(e))for(let l of e)if(l.type==="text")t+=(t?`
`:"")+l.text;else if(l.type==="tool_result"){let d=l.content;if(typeof d=="string")t+=(t?`
`:"")+d;else if(Array.isArray(d))for(let r of d)(r==null?void 0:r.type)==="text"&&r.text&&(t+=(t?`
`:"")+r.text)}else l.type==="image_url"&&((a=l.image_url)!=null&&a.url)&&s.push(l.image_url.url);let n=/File saved at:\s*(.+?openclaw-attachments\/[^\s\n]+)/g,i;for(;(i=n.exec(t))!==null;){let l=i[1].trim(),d=l.includes("openclaw-attachments/")?"openclaw-attachments/"+l.split("openclaw-attachments/")[1]:null;if(d)try{let r=this.app.vault.adapter.getResourcePath(d);r&&s.push(r)}catch(r){}}let o=/(?:^|\n)data:(image\/[^;]+);base64,[A-Za-z0-9+/=\n]+/g;for(;(i=o.exec(t))!==null;)s.push(i[0].replace(/^\n/,"").trim());return t=t.replace(/\n?data:image\/[^;]+;base64,[A-Za-z0-9+/=\n]+/g,"").trim(),t=t.replace(/^\[Attached image:.*?\]\s*/gm,"").trim(),t=t.replace(/^File saved at:.*$/gm,"").trim(),t=t.replace(/Conversation info \(untrusted metadata\):\s*```json[\s\S]*?```\s*/g,"").trim(),t=t.replace(/^```json\s*\{\s*"message_id"[\s\S]*?```\s*/gm,"").trim(),t=t.replace(/^\[.*?GMT[+-]\d+\]\s*/gm,"").trim(),t=t.replace(/^\[media attached:.*?\]\s*/gm,"").trim(),t=t.replace(/^To send an image back.*$/gm,"").trim(),(t==="NO_REPLY"||t==="HEARTBEAT_OK")&&(t=""),{text:t,images:s}}updateSendButton(){this.inputEl.value.trim()||this.pendingAttachments.length>0?(this.sendBtn.setAttribute("aria-label","Send"),this.sendBtn.removeClass("oc-opacity-low")):(this.sendBtn.setAttribute("aria-label","Send"),this.sendBtn.addClass("oc-opacity-low"))}async startRecording(){try{let e=await navigator.mediaDevices.getUserMedia({audio:!0});this.recordedChunks=[];let t=MediaRecorder.isTypeSupported("audio/webm;codecs=opus")?"audio/webm;codecs=opus":MediaRecorder.isTypeSupported("audio/webm")?"audio/webm":"";this.mediaRecorder=new MediaRecorder(e,t?{mimeType:t}:{}),this.mediaRecorder.addEventListener("dataavailable",s=>{s.data.size>0&&this.recordedChunks.push(s.data)}),this.mediaRecorder.addEventListener("stop",()=>{e.getTracks().forEach(s=>s.stop()),this.finishRecording()}),this.mediaRecorder.start(),this.recording=!0,this.updateSendButton(),this.inputEl.placeholder="Recording... tap \u25A0 to stop"}catch(e){console.error("[ObsidianClaw] Mic access failed:",e),new u.Notice("Microphone access denied")}}stopRecording(){this.mediaRecorder&&this.mediaRecorder.state!=="inactive"&&this.mediaRecorder.stop(),this.recording=!1,this.updateSendButton(),this.inputEl.placeholder="Message..."}async finishRecording(){var h;if(this.recordedChunks.length===0)return;let e=new Blob(this.recordedChunks,{type:((h=this.mediaRecorder)==null?void 0:h.mimeType)||"audio/webm"});this.recordedChunks=[];let t=await e.arrayBuffer(),s=new Uint8Array(t),n="";for(let m=0;m<s.length;m++)n+=String.fromCharCode(s[m]);let i=btoa(n),a=`AUDIO_DATA:${e.type||"audio/webm"};base64,${i}`;this.messages.push({role:"user",text:"\u{1F3A4} Voice message",images:[],timestamp:Date.now()}),await this.renderMessages();let l=K(),d=this.activeSessionKey,r={runId:l,text:"",toolCalls:[],items:[],splitPoints:[],lastDeltaTime:0,compactTimer:null,workingTimer:null};this.streams.set(d,r),this.runToSession.set(l,d),this.abortBtn.removeClass("oc-hidden"),this.typingEl.removeClass("oc-hidden");let c=this.typingEl.querySelector(".openclaw-typing-text");c&&(c.textContent="Thinking"),this.scrollToBottom();try{await this.plugin.gateway.request("chat.send",{sessionKey:d,message:a,deliver:!1,idempotencyKey:l})}catch(m){this.messages.push({role:"assistant",text:`Error: ${m}`,images:[],timestamp:Date.now()}),this.streams.delete(d),this.runToSession.delete(l),this.abortBtn.addClass("oc-hidden"),await this.renderMessages()}}async sendMessage(){var c;let e=this.inputEl.value.trim(),t=this.pendingAttachments.length>0;if(!e&&!t||this.sending)return;if(!((c=this.plugin.gateway)!=null&&c.connected)){new u.Notice("Not connected to OpenClaw gateway");return}this.sending=!0,this.sendBtn.disabled=!0,this.inputEl.value="",this.autoResize();let s=e,n=e,i=[],o=[];if(this.pendingAttachments.length>0){for(let h of this.pendingAttachments)h.base64&&h.mimeType?(o.push({type:"image",mimeType:h.mimeType,content:h.base64}),i.push(`data:${h.mimeType};base64,${h.base64}`)):s=(s?s+`

`:"")+h.content;e||(e=`\u{1F4CE} ${this.pendingAttachments.map(h=>h.name).join(", ")}`,s=e),this.pendingAttachments=[],this.attachPreviewEl.addClass("oc-hidden")}this.messages.push({role:"user",text:n||e,images:i,timestamp:Date.now()}),await this.renderMessages();let a=K(),l=this.activeSessionKey,d={runId:a,text:"",toolCalls:[],items:[],splitPoints:[],lastDeltaTime:0,compactTimer:null,workingTimer:null};this.streams.set(l,d),this.runToSession.set(a,l),this.abortBtn.removeClass("oc-hidden"),this.typingEl.removeClass("oc-hidden");let r=this.typingEl.querySelector(".openclaw-typing-text");r&&(r.textContent="Thinking"),this.scrollToBottom(),d.compactTimer=setTimeout(()=>{let h=this.streams.get(l);if((h==null?void 0:h.runId)===a&&!h.text&&this.activeSessionKey===l){let m=this.typingEl.querySelector(".openclaw-typing-text");m&&m.textContent==="Thinking"&&(m.textContent="Still thinking")}},15e3);try{let h={sessionKey:l,message:s,deliver:!1,idempotencyKey:a};o.length>0&&(h.attachments=o),await this.plugin.gateway.request("chat.send",h)}catch(h){d.compactTimer&&clearTimeout(d.compactTimer),this.messages.push({role:"assistant",text:`Error: ${h}`,images:[],timestamp:Date.now()}),this.streams.delete(l),this.runToSession.delete(a),this.abortBtn.addClass("oc-hidden"),await this.renderMessages()}finally{this.sending=!1,this.sendBtn.disabled=!1}}async abortMessage(){var t;let e=this.activeStream;if(!(!((t=this.plugin.gateway)!=null&&t.connected)||!e))try{await this.plugin.gateway.request("chat.abort",{sessionKey:this.activeSessionKey,runId:e.runId})}catch(s){}}async updateContextMeter(){var e,t;if((e=this.plugin.gateway)!=null&&e.connected)try{let s=await this.plugin.gateway.request("sessions.list",{}),n=(s==null?void 0:s.sessions)||[],i=this.plugin.settings.sessionKey||"main",o=n.find(v=>v.key===i)||n.find(v=>v.key===`${this.agentPrefix}${i}`)||n.find(v=>v.key.endsWith(`:${i}`));if(!o)return;let a=o.totalTokens||0,l=o.contextTokens||2e5,d=Math.min(100,Math.round(a/l*100));this.contextFillEl.setCssStyles({width:d+"%"}),this.contextFillEl.className="openclaw-context-fill"+(d>80?" openclaw-context-high":d>60?" openclaw-context-mid":""),this.contextLabelEl.textContent=`${d}%`;let r=(t=this.tabBarEl)==null?void 0:t.querySelector(".openclaw-tab.active .openclaw-tab-meter-fill");r&&r.setCssStyles({width:d+"%"});let c=o.model||"",h=Date.now()-this.currentModelSetAt<15e3;c&&c!==this.currentModel&&!h&&(this.currentModel=c,this.updateModelPill()),o.displayName&&o.displayName!==this.cachedSessionDisplayName&&(this.cachedSessionDisplayName=o.displayName);let m=this.agentPrefix,y=new Set(n.filter(v=>v.key.startsWith(m)&&!v.key.includes(":cron:")&&!v.key.includes(":subagent:")).map(v=>v.key)),f=new Set(this.tabSessions.map(v=>`${m}${v.key}`)),k=[...y].some(v=>!f.has(v)),E=[...f].some(v=>!y.has(v));(k||E)&&!this.tabDeleteInProgress&&(E&&!y.has(`${m}${i}`)&&(this.plugin.settings.sessionKey="main",await this.plugin.saveSettings(),this.messages=[],this.messagesEl.empty(),await this.loadHistory(),this.updateStatus()),await this.renderTabs())}catch(s){}}updateModelPill(){if(!this.modelLabelEl)return;let e=this.currentModel?this.shortModelName(this.currentModel):"model";this.modelLabelEl.empty(),this.modelLabelEl.createSpan({text:e,cls:"openclaw-ctx-pill-text"}),this.modelLabelEl.createSpan({text:" \u25BE",cls:"openclaw-ctx-pill-arrow"})}async renderTabs(){if(!(!this.tabBarEl||this.renderingTabs)){this.renderingTabs=!0;try{await this._renderTabsInner()}finally{this.renderingTabs=!1}}}async _renderTabsInner(){var d;this.tabBarEl.empty();let e=this.plugin.settings.sessionKey||"main",t=[];if((d=this.plugin.gateway)!=null&&d.connected)try{let r=await this.plugin.gateway.request("sessions.list",{});t=(r==null?void 0:r.sessions)||[]}catch(r){}let s=this.agentPrefix,n=t.filter(r=>!(!r.key.startsWith(s)||r.key.includes(":cron:")||r.key.includes(":subagent:")));this.tabSessions=[];let i=n.find(r=>r.key===`${this.agentPrefix}main`);if(i){let r=i.totalTokens||0,c=i.contextTokens||2e5;this.tabSessions.push({key:"main",label:"Main",pct:Math.min(100,Math.round(r/c*100))})}else this.tabSessions.push({key:"main",label:"Main",pct:0});let o=n.filter(r=>r.key.slice(s.length)!=="main").sort((r,c)=>(r.createdAt||r.updatedAt||0)-(c.createdAt||c.updatedAt||0)),a=1;for(let r of o){let c=r.key.slice(s.length),h=r.totalTokens||0,m=r.contextTokens||2e5,y=Math.min(100,Math.round(h/m*100)),f=r.label||r.displayName||String(a);this.tabSessions.push({key:c,label:f,pct:y}),a++}for(let r of this.tabSessions){let c=r.key===e,h=`openclaw-tab${c?" active":""}`,m=this.tabBarEl.createDiv({cls:h}),y=m.createDiv({cls:"openclaw-tab-row"}),f=r.label;y.createSpan({text:f,cls:"openclaw-tab-label"});let k=r.key==="main",E=y.createSpan({text:"\xD7",cls:"openclaw-tab-close"});k?(E.title="Reset conversation",E.addEventListener("click",T=>{T.stopPropagation(),(async()=>{var x;if((x=this.plugin.gateway)!=null&&x.connected)try{await this.plugin.gateway.request("chat.send",{sessionKey:r.key,message:"/reset",deliver:!1,idempotencyKey:"reset-"+Date.now()}),new u.Notice(`Reset: ${r.label}`),r.key===e&&(this.messages=[],this.messagesEl.empty()),await this.updateContextMeter(),await this.renderTabs()}catch(b){new u.Notice(`Reset failed: ${b instanceof Error?b.message:String(b)}`)}})()})):(E.title="Close tab",E.addEventListener("click",T=>{T.stopPropagation(),(async()=>{var x;if(!(!((x=this.plugin.gateway)!=null&&x.connected)||this.tabDeleteInProgress)){this.tabDeleteInProgress=!0;try{let b=await Q(this.plugin.gateway,`${this.agentPrefix}${r.key}`);new u.Notice(b?`Closed: ${r.label}`:`Could not delete: ${r.label}`)}catch(b){new u.Notice(`Close failed: ${b instanceof Error?b.message:String(b)}`)}this.finishStream(r.key),r.key===e&&(this.plugin.settings.sessionKey="main",await this.plugin.saveSettings(),this.messages=[],this.messagesEl.empty(),await this.loadHistory(),this.restoreStreamUI()),this.tabDeleteInProgress=!1,await this.renderTabs(),await this.updateContextMeter()}})()})),m.createDiv({cls:"openclaw-tab-meter"}).createDiv({cls:"openclaw-tab-meter-fill"}).setCssStyles({width:r.pct+"%"}),c||m.addEventListener("click",()=>void(async()=>{this.streamEl=null,this.typingEl.addClass("oc-hidden"),this.abortBtn.addClass("oc-hidden"),this.hideBanner(),this.plugin.settings.sessionKey=r.key,await this.plugin.saveSettings(),this.messages=[],this.messagesEl.empty(),this.cachedSessionDisplayName=r.label,await this.loadHistory(),this.restoreStreamUI(),await this.updateContextMeter(),this.renderTabs(),this.updateStatus()})())}let l=this.tabBarEl.createDiv({cls:"openclaw-tab openclaw-tab-add"});l.createSpan({text:"+",cls:"openclaw-tab-label"}),l.addEventListener("click",()=>void(async()=>{var m,y;let r=this.tabSessions.map(f=>parseInt(f.label)).filter(f=>!isNaN(f)),c=r.length>0?Math.max(...r)+1:1,h=`tab-${c}`;try{await((m=this.plugin.gateway)==null?void 0:m.request("chat.send",{sessionKey:h,message:"/new",deliver:!1,idempotencyKey:"newtab-"+Date.now()})),await new Promise(f=>setTimeout(f,500));try{await((y=this.plugin.gateway)==null?void 0:y.request("sessions.patch",{key:`${this.agentPrefix}${h}`,label:String(c)}))}catch(f){}this.streamEl=null,this.typingEl.addClass("oc-hidden"),this.abortBtn.addClass("oc-hidden"),this.hideBanner(),this.plugin.settings.sessionKey=h,this.messages=[],this.plugin.settings.streamItemsMap&&(this.plugin.settings.streamItemsMap={}),await this.plugin.saveSettings(),this.messagesEl.empty(),await this.renderTabs(),await this.updateContextMeter(),new u.Notice(`New tab: ${c}`)}catch(f){new u.Notice(`Failed to create tab: ${f instanceof Error?f.message:String(f)}`)}})())}contextColor(e){return e>80?"#c44":e>60?"#d4a843":e>30?"#7a7":"#5a5"}async resetCurrentTab(){var e;if((e=this.plugin.gateway)!=null&&e.connected)try{await this.plugin.gateway.request("chat.send",{sessionKey:this.plugin.settings.sessionKey,message:"/reset",deliver:!1,idempotencyKey:"reset-"+Date.now()}),this.messages=[],this.plugin.settings.streamItemsMap&&(this.plugin.settings.streamItemsMap={}),await this.plugin.saveSettings(),this.messagesEl.empty(),await this.updateContextMeter(),await this.renderTabs(),new u.Notice("Tab reset")}catch(t){new u.Notice(`Reset failed: ${t}`)}}openModelPicker(){new O(this.app,this.plugin,this).open()}async compactSession(){var e;if((e=this.plugin.gateway)!=null&&e.connected)try{this.showBanner("Compacting context..."),await this.plugin.gateway.request("chat.send",{sessionKey:this.plugin.settings.sessionKey,message:"/compact",deliver:!1,idempotencyKey:"compact-"+Date.now()});let t=setInterval(()=>void(async()=>{await this.updateContextMeter()})(),2e3);setTimeout(()=>void(async()=>{clearInterval(t),this.hideBanner(),await this.loadHistory(),await this.updateContextMeter()})(),12e3)}catch(t){this.hideBanner(),new u.Notice(`Compact failed: ${t}`)}}async newSession(){var e;if((e=this.plugin.gateway)!=null&&e.connected)try{await this.plugin.gateway.request("chat.send",{sessionKey:this.plugin.settings.sessionKey,message:"/new",deliver:!1,idempotencyKey:"new-"+Date.now()}),this.messages=[],this.plugin.settings.streamItemsMap&&(this.plugin.settings.streamItemsMap={}),await this.plugin.saveSettings(),this.messagesEl.empty(),await this.updateContextMeter(),new u.Notice("New session started")}catch(t){new u.Notice(`New session failed: ${t}`)}}shortModelName(e){return(e.includes("/")?e.split("/")[1]:e).replace(/^claude-/,"")}async handleFileSelect(){let e=this.fileInputEl.files;if(!(!e||e.length===0)){for(let t of Array.from(e))try{let s=t.type.startsWith("image/"),n=t.type.startsWith("text/")||["application/json","application/yaml","application/xml","application/javascript"].includes(t.type)||/\.(md|txt|json|csv|yaml|yml|js|ts|py|html|css|xml|toml|ini|sh|log)$/i.test(t.name);if(s){let i=await this.resizeImage(t,2048,.85);this.pendingAttachments.push({name:t.name,content:`[Attached image: ${t.name}]`,base64:i.base64,mimeType:i.mimeType})}else if(n){let i=await t.text(),o=i.length>1e4?i.slice(0,1e4)+`
...(truncated)`:i;this.pendingAttachments.push({name:t.name,content:`File: ${t.name}
\`\`\`
${o}
\`\`\``})}else this.pendingAttachments.push({name:t.name,content:`[Attached file: ${t.name} (${t.type||"unknown type"}, ${Math.round(t.size/1024)}KB)]`})}catch(s){new u.Notice(`Failed to attach ${t.name}: ${s}`)}this.renderAttachPreview(),this.fileInputEl.value=""}}async handlePastedFile(e){try{let t=e.type.split("/")[1]||"png",s=await this.resizeImage(e,2048,.85);this.pendingAttachments.push({name:`clipboard.${t}`,content:`[Attached image: clipboard.${t}]`,base64:s.base64,mimeType:s.mimeType}),this.renderAttachPreview()}catch(t){new u.Notice(`Failed to paste image: ${t}`)}}async resizeImage(e,t,s){return new Promise((n,i)=>{let o=new Image,a=URL.createObjectURL(e);o.onload=()=>{URL.revokeObjectURL(a);let{width:l,height:d}=o;if(l>t||d>t){let y=t/Math.max(l,d);l=Math.round(l*y),d=Math.round(d*y)}let r=document.createElement("canvas");r.width=l,r.height=d;let c=r.getContext("2d");if(!c){i(new Error("No canvas context"));return}c.drawImage(o,0,0,l,d);let m=r.toDataURL("image/jpeg",s).split(",")[1];n({base64:m,mimeType:"image/jpeg"})},o.onerror=()=>{URL.revokeObjectURL(a),i(new Error("Failed to load image"))},o.src=a})}renderAttachPreview(){if(this.attachPreviewEl.empty(),this.pendingAttachments.length===0){this.attachPreviewEl.addClass("oc-hidden");return}this.attachPreviewEl.removeClass("oc-hidden");for(let e=0;e<this.pendingAttachments.length;e++){let t=this.pendingAttachments[e],s=this.attachPreviewEl.createDiv("openclaw-attach-chip");if(t.base64&&t.mimeType){let o=`data:${t.mimeType};base64,${t.base64}`;s.createEl("img",{cls:"openclaw-attach-thumb",attr:{src:o}})}else if(t.vaultPath)try{let o=this.app.vault.adapter.getResourcePath(t.vaultPath);o&&s.createEl("img",{cls:"openclaw-attach-thumb",attr:{src:o}})}catch(o){}s.createSpan({text:t.name,cls:"openclaw-attach-name"});let n=s.createEl("button",{text:"\u2715",cls:"openclaw-attach-remove"}),i=e;n.addEventListener("click",()=>{this.pendingAttachments.splice(i,1),this.renderAttachPreview()})}}buildToolLabel(e,t){let s=t!=null?t:{};switch(e){case"exec":{let n=w(s==null?void 0:s.command);return{label:`\u{1F527} ${(n.length>60?n.slice(0,60)+"\u2026":n)||"Running command"}`}}case"read":case"Read":return{label:`\u{1F4C4} Reading ${w(s==null?void 0:s.path,w(s==null?void 0:s.file_path)).split("/").pop()||"file"}`};case"write":case"Write":return{label:`\u270F\uFE0F Writing ${w(s==null?void 0:s.path,w(s==null?void 0:s.file_path)).split("/").pop()||"file"}`};case"edit":case"Edit":return{label:`\u270F\uFE0F Editing ${w(s==null?void 0:s.path,w(s==null?void 0:s.file_path)).split("/").pop()||"file"}`};case"web_search":{let n=w(s==null?void 0:s.query);return{label:`\u{1F50D} Searching "${n.length>40?n.slice(0,40)+"\u2026":n}"`}}case"web_fetch":{let n=w(s==null?void 0:s.url);try{return{label:`\u{1F310} Fetching ${new URL(n).hostname}`,url:n}}catch(i){return{label:"\u{1F310} Fetching page",url:n||void 0}}}case"browser":return{label:"\u{1F310} Using browser"};case"image":return{label:"\u{1F441}\uFE0F Viewing image"};case"memory_search":{let n=w(s==null?void 0:s.query);return{label:`\u{1F9E0} Searching "${n.length>40?n.slice(0,40)+"\u2026":n}"`}}case"memory_get":return{label:`\u{1F9E0} Reading ${w(s==null?void 0:s.path).split("/").pop()||"memory"}`};case"message":return{label:"\u{1F4AC} Sending message"};case"tts":return{label:"\u{1F50A} Speaking"};case"sessions_spawn":return{label:"\u{1F916} Spawning sub-agent"};default:return{label:e?`\u26A1 ${e}`:"Working"}}}appendToolCall(e,t,s=!1){let n=document.createElement("div");if(n.className="openclaw-tool-item"+(s?" openclaw-tool-active":""),t){let i=document.createElement("a");i.href=t,i.textContent=e,i.className="openclaw-tool-link",i.addEventListener("click",o=>{o.preventDefault(),window.open(t,"_blank")}),n.appendChild(i)}else{let i=document.createElement("span");i.textContent=e,n.appendChild(i)}if(s){let i=document.createElement("span");i.className="openclaw-tool-dots",i.createSpan("openclaw-dot"),i.createSpan("openclaw-dot"),i.createSpan("openclaw-dot"),n.appendChild(i)}this.messagesEl.appendChild(n),this.scrollToBottom()}deactivateLastToolItem(){let e=this.messagesEl.querySelectorAll(".openclaw-tool-active"),t=e[e.length-1];if(t){t.removeClass("openclaw-tool-active");let s=t.querySelector(".openclaw-tool-dots");s&&s.remove()}}async playTTSAudio(e){}showBanner(e){this.bannerEl&&(this.bannerEl.textContent=e,this.bannerEl.removeClass("oc-hidden"))}hideBanner(){this.bannerEl&&this.bannerEl.addClass("oc-hidden")}resolveStreamSession(e){let t=w(e.sessionKey);if(t){let i=this.agentPrefix,o=t.startsWith(i)?t.slice(i.length):t;if(this.streams.has(o))return o}let s=e.data,n=w(e.runId,w(s==null?void 0:s.runId));return n&&this.runToSession.has(n)?this.runToSession.get(n):this.streams.size===1?this.streams.keys().next().value:null}handleStreamEvent(e){let t=w(e.stream),s=w(e.state),n=e.data,i=this.resolveStreamSession(e),o=i===this.activeSessionKey;if(!i||!this.streams.has(i)){if(t==="compaction"||s==="compacting"){let c=w(n==null?void 0:n.phase);(o||!i)&&(c==="end"?setTimeout(()=>this.hideBanner(),2e3):this.showBanner("Compacting context..."))}return}let a=this.streams.get(i),l=this.typingEl.querySelector(".openclaw-typing-text");if(s==="assistant"){let c=Date.now()-a.lastDeltaTime;a.text&&c>1500?a.workingTimer||(a.workingTimer=setTimeout(()=>{this.streams.has(i)&&o&&this.typingEl.hasClass("oc-hidden")&&(l&&(l.textContent="Working"),this.typingEl.removeClass("oc-hidden")),a.workingTimer=null},500)):!a.text&&!a.lastDeltaTime&&o&&this.typingEl.removeClass("oc-hidden")}else s==="lifecycle"&&!a.text&&o&&l&&(l.textContent="Thinking",this.typingEl.removeClass("oc-hidden"));let d=w(n==null?void 0:n.name,w(n==null?void 0:n.toolName,w(e.toolName,w(e.name)))),r=w(n==null?void 0:n.phase,w(e.phase));if((t==="tool"||d)&&(r==="start"||s==="tool_use")){a.compactTimer&&(clearTimeout(a.compactTimer),a.compactTimer=null),a.workingTimer&&(clearTimeout(a.workingTimer),a.workingTimer=null),a.text&&a.splitPoints.push(a.text.length);let{label:c,url:h}=this.buildToolLabel(d,(n==null?void 0:n.args)||e.args);a.toolCalls.push(c),a.items.push({type:"tool",label:c,url:h}),o&&(this.appendToolCall(c,h,!0),l&&(l.textContent=c),this.typingEl.removeClass("oc-hidden"))}else(t==="tool"||d)&&r==="result"?o&&(this.deactivateLastToolItem(),l&&(l.textContent="Thinking"),this.typingEl.removeClass("oc-hidden"),this.scrollToBottom()):(t==="compaction"||s==="compacting")&&(r==="end"?o&&setTimeout(()=>this.hideBanner(),2e3):(a.toolCalls.push("Compacting memory"),a.items.push({type:"tool",label:"Compacting memory"}),o&&(this.appendToolCall("Compacting memory"),this.typingEl.addClass("oc-hidden"),this.showBanner("Compacting context..."))))}handleChatEvent(e){let t=w(e.sessionKey),s=this.agentPrefix,n=null;for(let l of[...this.streams.keys(),this.activeSessionKey])if(t===l||t===`${s}${l}`||t.endsWith(`:${l}`)){n=l;break}if(!n){let l=this.activeSessionKey;if(t===l||t===`${s}${l}`||t.endsWith(`:${l}`))n=l;else return}let i=this.streams.get(n),o=n===this.activeSessionKey,a=w(e.state);if(!i&&(a==="final"||a==="aborted"||a==="error")){o&&(this.hideBanner(),this.loadHistory());return}if(a==="delta"&&i){i.compactTimer&&(clearTimeout(i.compactTimer),i.compactTimer=null),i.workingTimer&&(clearTimeout(i.workingTimer),i.workingTimer=null),i.lastDeltaTime=Date.now();let l=this.extractDeltaText(e.message);l&&(i.text=l,o&&(this.typingEl.addClass("oc-hidden"),this.hideBanner(),this.updateStreamBubble()))}else if(a==="final"){let l=i?[...i.items]:[];this.finishStream(n),o&&this.loadHistory().then(async()=>{if(await this.renderMessages(),this.updateContextMeter(),l.length>0){let d=[...this.messages].reverse().find(r=>r.role==="assistant");if(d){let r=String(d.timestamp);this.plugin.settings.streamItemsMap||(this.plugin.settings.streamItemsMap={}),this.plugin.settings.streamItemsMap[r]=l,this.plugin.saveSettings()}}})}else a==="aborted"?(o&&(i!=null&&i.text)&&this.messages.push({role:"assistant",text:i.text,images:[],timestamp:Date.now()}),this.finishStream(n),o&&this.renderMessages()):a==="error"&&(o&&this.messages.push({role:"assistant",text:`Error: ${w(e.errorMessage,"unknown error")}`,images:[],timestamp:Date.now()}),this.finishStream(n),o&&this.renderMessages())}finishStream(e){let t=e!=null?e:this.activeSessionKey,s=this.streams.get(t);if(s&&(s.compactTimer&&clearTimeout(s.compactTimer),s.workingTimer&&clearTimeout(s.workingTimer),this.runToSession.delete(s.runId),this.streams.delete(t)),t===this.activeSessionKey){this.hideBanner(),this.streamEl=null,this.abortBtn.addClass("oc-hidden"),this.typingEl.addClass("oc-hidden");let n=this.typingEl.querySelector(".openclaw-typing-text");n&&(n.textContent="Thinking")}}restoreStreamUI(){let e=this.activeStream;if(e){this.abortBtn.removeClass("oc-hidden");for(let t of e.items)t.type==="tool"&&this.appendToolCall(t.label,t.url);if(e.text){this.updateStreamBubble();let t=this.typingEl.querySelector(".openclaw-typing-text");t&&(t.textContent="Working"),this.typingEl.removeClass("oc-hidden")}else{let t=this.typingEl.querySelector(".openclaw-typing-text");t&&(t.textContent="Thinking"),this.typingEl.removeClass("oc-hidden")}this.scrollToBottom()}}insertStreamItemsBeforeLastAssistant(e){var n;if(e.length===0)return;let t=this.messagesEl.querySelectorAll(".openclaw-msg-assistant"),s=t[t.length-1];if(s){for(let i of e){let o=this.createStreamItemEl(i);(n=s.parentElement)==null||n.insertBefore(o,s)}this.scrollToBottom()}}createStreamItemEl(e){if(e.type==="tool"){let t=document.createElement("div");if(t.className="openclaw-tool-item",e.url){let s=document.createElement("a");s.href=e.url,s.textContent=e.label,s.className="openclaw-tool-link",s.addEventListener("click",n=>{n.preventDefault(),window.open(e.url,"_blank")}),t.appendChild(s)}else t.textContent=e.label;return t}else{let t=document.createElement("details");t.className="openclaw-intermediary";let s=document.createElement("summary");s.className="openclaw-intermediary-summary";let n=e.text.length>60?e.text.slice(0,60)+"...":e.text;s.textContent=n,t.appendChild(s);let i=document.createElement("div");return i.className="openclaw-intermediary-content",i.textContent=e.text,t.appendChild(i),t}}cleanText(e){return e=e.replace(/Conversation info \(untrusted metadata\):\s*```json[\s\S]*?```\s*/g,"").trim(),e=e.replace(/^```json\s*\{\s*"message_id"[\s\S]*?```\s*/gm,"").trim(),e=e.replace(/^\[.*?GMT[+-]\d+\]\s*/gm,"").trim(),e=e.replace(/^\[media attached:.*?\]\s*/gm,"").trim(),e=e.replace(/^To send an image back.*$/gm,"").trim(),e=e.replace(/^\[\[audio_as_voice\]\]\s*/gm,"").trim(),e=e.replace(/^MEDIA:\/[^\n]+$/gm,"").trim(),e=e.replace(/^VOICE:[^\s\n]+$/gm,"").trim(),e=e.replace(/^AUDIO_DATA:[^\n]+$/gm,"").trim(),e==="\u{1F3A4} Voice message"&&(e="\u{1F3A4} Voice message"),e==="NO_REPLY"||e==="HEARTBEAT_OK"?"":e}extractVoiceRefs(e){let t=[],s=/^VOICE:([^\s\n]+\.(?:mp3|opus|ogg|wav|m4a|mp4))$/gm,n;for(;(n=s.exec(e))!==null;)t.push(n[1].trim());return t}buildVoiceUrl(e){return`${(this.plugin.settings.gatewayUrl||"").replace(/^ws(s?):\/\//,"http$1://")}/${e}`}renderAudioPlayer(e,t){let s=e.createDiv("openclaw-audio-player"),n=s.createEl("button",{cls:"openclaw-audio-play-btn",text:"\u25B6 voice message"}),o=s.createDiv("openclaw-audio-progress").createDiv("openclaw-audio-bar"),a=null;n.addEventListener("click",()=>void(async()=>{if(a&&!a.paused){a.pause(),n.textContent="\u25B6 voice message";return}if(!a){n.textContent="\u23F3 loading...";try{let l=this.buildVoiceUrl(t);console.debug("[ObsidianClaw] Loading audio from:",l),a=new Audio(l),await new Promise((d,r)=>{let c=setTimeout(()=>r(new Error("timeout")),1e4);a.addEventListener("canplaythrough",()=>{clearTimeout(c),d()},{once:!0}),a.addEventListener("error",()=>{clearTimeout(c),r(new Error("load error"))},{once:!0}),a.load()}),a.addEventListener("timeupdate",()=>{a&&a.duration&&o.setCssStyles({width:`${a.currentTime/a.duration*100}%`})}),a.addEventListener("ended",()=>{n.textContent="\u25B6 voice message",o.setCssStyles({width:"0%"})})}catch(l){console.error("[ObsidianClaw] Audio load failed:",l),n.textContent="\u26A0 audio unavailable",n.disabled=!0;return}}n.textContent="\u23F8 playing...",a.play().catch(()=>{n.textContent="\u26A0 audio unavailable",n.disabled=!0})})())}extractDeltaText(e){var s;if(typeof e=="string")return e;if(!e)return"";let t=(s=e.content)!=null?s:e;if(Array.isArray(t)){let n="";for(let i of t)typeof i=="string"?n+=i:i&&typeof i=="object"&&"text"in i&&(n+=(n?`
`:"")+String(i.text));return n}return typeof t=="string"?t:w(e.text)}updateStreamBubble(){let e=this.activeStream,t=e==null?void 0:e.text;t&&(this.streamEl||(this.streamEl=this.messagesEl.createDiv("openclaw-msg openclaw-msg-assistant openclaw-streaming"),this.scrollToBottom()),this.streamEl.empty(),this.streamEl.createDiv({text:t,cls:"openclaw-msg-text"}))}async renderMessages(){var e,t;this.messagesEl.empty();for(let s of this.messages){if(s.role==="assistant"&&(((e=s.contentBlocks)==null?void 0:e.some(l=>l.type==="tool_use"||l.type==="toolCall"))||!1)&&s.contentBlocks){for(let l of s.contentBlocks)if(l.type==="text"&&((t=l.text)!=null&&t.trim())){let d=this.extractVoiceRefs(l.text),r=this.cleanText(l.text);if(r){let c=this.messagesEl.createDiv("openclaw-msg openclaw-msg-assistant");try{await u.MarkdownRenderer.render(this.app,r,c,"",this)}catch(h){c.createDiv({text:r,cls:"openclaw-msg-text"})}for(let h of d)this.renderAudioPlayer(c,h)}else if(d.length>0){let c=this.messagesEl.createDiv("openclaw-msg openclaw-msg-assistant");for(let h of d)this.renderAudioPlayer(c,h)}}else if(l.type==="tool_use"||l.type==="toolCall"){let{label:d,url:r}=this.buildToolLabel(l.name||"",l.input||l.arguments||{}),c=this.createStreamItemEl({type:"tool",label:d,url:r});this.messagesEl.appendChild(c)}continue}let n=s.role==="user"?"openclaw-msg-user":"openclaw-msg-assistant",i=this.messagesEl.createDiv(`openclaw-msg ${n}`);if(s.images&&s.images.length>0){let a=i.createDiv("openclaw-msg-images");for(let l of s.images)a.createEl("img",{cls:"openclaw-msg-img",attr:{src:l,loading:"lazy"}}).addEventListener("click",()=>{let r=document.body.createDiv("openclaw-img-overlay");r.createEl("img",{attr:{src:l}}),r.addEventListener("click",()=>r.remove())})}let o=s.text?this.extractVoiceRefs(s.text):[];if(s.text){let a=s.role==="assistant"?this.cleanText(s.text):s.text;if(a)if(s.role==="assistant")try{await u.MarkdownRenderer.render(this.app,a,i,"",this)}catch(l){i.createDiv({text:a,cls:"openclaw-msg-text"})}else i.createDiv({text:a,cls:"openclaw-msg-text"})}for(let a of o)this.renderAudioPlayer(i,a)}this.scrollToBottom()}scrollToBottom(){this.messagesEl&&requestAnimationFrame(()=>{this.messagesEl.scrollTop=this.messagesEl.scrollHeight})}autoResize(){this.inputEl.setCssStyles({height:"auto"}),this.inputEl.setCssStyles({height:Math.min(this.inputEl.scrollHeight,150)+"px"})}},P=class extends u.Plugin{constructor(){super(...arguments);this.settings=U;this.gateway=null;this.gatewayConnected=!1;this.chatView=null}async onload(){await this.loadSettings(),this.registerView(S,e=>new $(e,this)),this.addRibbonIcon("message-square","OpenClaw chat",()=>{this.activateView()}),this.addCommand({id:"toggle-chat",name:"Toggle chat sidebar",callback:()=>void this.activateView()}),this.addCommand({id:"ask-about-note",name:"Ask about current note",callback:()=>void this.askAboutNote()}),this.addCommand({id:"reconnect",name:"Reconnect to gateway",callback:()=>void this.connectGateway()}),this.addCommand({id:"setup",name:"Run setup wizard",callback:()=>new C(this.app,this).open()}),this.addSettingTab(new H(this.app,this)),this.settings.onboardingComplete?(this.connectGateway(),this.app.workspace.onLayoutReady(()=>{this.activateView()})):setTimeout(()=>new C(this.app,this).open(),500)}onunload(){var e;(e=this.gateway)==null||e.stop(),this.gateway=null,this.gatewayConnected=!1}async loadSettings(){this.settings=Object.assign({},U,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async connectGateway(){var n,i;(n=this.gateway)==null||n.stop(),this.gatewayConnected=!1,(i=this.chatView)==null||i.updateStatus();let e=this.settings.gatewayUrl.trim();if(!e)return;let t=D(e);if(!t){new u.Notice("OpenClaw: Invalid gateway URL. Use your Tailscale Serve URL (e.g. wss://your-machine.tail1234.ts.net)");return}t!==e&&(this.settings.gatewayUrl=t,await this.saveSettings());let s;try{s=await J(()=>this.loadData(),o=>this.saveData(o))}catch(o){console.warn("[ObsidianClaw] Device identity creation failed, connecting without scopes:",o)}this.gateway=new B({url:t,token:this.settings.token.trim()||void 0,deviceIdentity:s,onHello:()=>{var o,a,l,d;this.gatewayConnected=!0,(o=this.chatView)==null||o.updateStatus(),(a=this.chatView)==null||a.loadHistory(),(l=this.chatView)==null||l.renderTabs(),(d=this.chatView)==null||d.loadAgents(),this.settings.currentModel&&this.chatView&&(this.chatView.currentModel=this.settings.currentModel,this.chatView.updateModelPill())},onClose:o=>{var a;this.gatewayConnected=!1,(a=this.chatView)==null||a.updateStatus(),(o.reason.includes("pairing required")||o.reason.includes("device identity required"))&&new u.Notice("OpenClaw: Device pairing required. Run 'openclaw devices approve' on your gateway machine.",1e4)},onEvent:o=>{var a,l;o.event==="chat"?(a=this.chatView)==null||a.handleChatEvent(o.payload):(o.event==="stream"||o.event==="agent")&&((l=this.chatView)==null||l.handleStreamEvent(o.payload))}}),this.gateway.start()}async activateView(){let e=this.app.workspace.getLeavesOfType(S);if(e.length>0){this.app.workspace.revealLeaf(e[0]);return}let t=this.app.workspace.getRightLeaf(!1);t&&(await t.setViewState({type:S,active:!0}),this.app.workspace.revealLeaf(t))}async askAboutNote(){var i;let e=this.app.workspace.getActiveFile();if(!e){new u.Notice("No active note");return}let t=await this.app.vault.read(e);if(!t.trim()){new u.Notice("Note is empty");return}if(await this.activateView(),!this.chatView||!((i=this.gateway)!=null&&i.connected)){new u.Notice("Not connected to OpenClaw");return}let s=`Here is my current note "${e.basename}":

${t}

What can you tell me about this?`,n=this.chatView.containerEl.querySelector(".openclaw-input");n&&(n.value=s,n.focus())}},O=class extends u.Modal{constructor(e,t,s){super(e);this.models=[];this.currentModel="";this.selectedProvider=null;this.plugin=t,this.chatView=s}async onOpen(){var t;this.modalEl.addClass("openclaw-picker"),this.contentEl.createDiv("openclaw-picker-loading").textContent="Loading models...";try{let s=await((t=this.plugin.gateway)==null?void 0:t.request("models.list",{}));this.models=(s==null?void 0:s.models)||[]}catch(s){this.models=[]}if(this.currentModel=this.chatView.currentModel||"",this.currentModel&&!this.currentModel.includes("/")){let s=this.models.find(n=>n.id===this.currentModel);s&&(this.currentModel=`${s.provider}/${s.id}`)}this.currentModel.includes("/")&&(this.selectedProvider=this.currentModel.split("/")[0]);let e=new Set(this.models.map(s=>s.provider));e.size===1?this.renderModels([...e][0]):this.renderProviders()}onClose(){this.contentEl.empty()}renderProviders(){let{contentEl:e}=this;e.empty();let t=new Map;for(let o of this.models){let a=o.provider||"unknown";t.has(a)||t.set(a,[]),t.get(a).push(o)}let s=this.currentModel.includes("/")?this.currentModel.split("/")[0]:"",n=e.createDiv("openclaw-picker-list");for(let[o,a]of t){let l=o===s,d=n.createDiv({cls:`openclaw-picker-row${l?" active":""}`}),r=d.createDiv("openclaw-picker-row-left");l&&r.createSpan({text:"\u25CF ",cls:"openclaw-picker-dot"}),r.createSpan({text:o,cls:"openclaw-picker-provider-name"});let c=d.createDiv("openclaw-picker-row-right");c.createSpan({text:`${a.length} model${a.length!==1?"s":""}`,cls:"openclaw-picker-meta"}),c.createSpan({text:" \u2192",cls:"openclaw-picker-arrow"}),d.addEventListener("click",()=>{this.selectedProvider=o,this.renderModels(o)})}let i=e.createDiv("openclaw-picker-hint openclaw-picker-footer");i.appendText("Want more models? "),i.createEl("a",{text:"Add them in your gateway config.",href:"https://docs.openclaw.ai/gateway/configuration#choose-and-configure-models"})}renderModels(e){let{contentEl:t}=this;t.empty(),new Set(this.models.map(o=>o.provider)).size>1&&t.createDiv("openclaw-picker-header").createEl("button",{cls:"openclaw-picker-back",text:"\u2190 "+e}).addEventListener("click",()=>this.renderProviders());let n=this.models.filter(o=>o.provider===e),i=t.createDiv("openclaw-picker-list openclaw-picker-model-list");for(let o of n){let a=`${o.provider}/${o.id}`,l=a===this.currentModel,d=i.createDiv({cls:`openclaw-picker-row${l?" active":""}`}),r=d.createDiv("openclaw-picker-row-left");l&&r.createSpan({text:"\u25CF ",cls:"openclaw-picker-dot"}),r.createSpan({text:o.name||o.id}),d.addEventListener("click",()=>void(async()=>{var c;if((c=this.plugin.gateway)!=null&&c.connected){d.addClass("openclaw-picker-selecting"),d.textContent="Switching...";try{await this.plugin.gateway.request("chat.send",{sessionKey:this.plugin.settings.sessionKey,message:`/model ${a}`,deliver:!1,idempotencyKey:"model-"+Date.now()}),this.chatView.currentModel=a,this.chatView.currentModelSetAt=Date.now(),this.plugin.settings.currentModel=a,await this.plugin.saveSettings(),this.chatView.updateModelPill(),new u.Notice(`Model: ${o.name||o.id}`),this.close()}catch(h){new u.Notice(`Failed: ${h}`),this.renderModels(e)}}})())}}};var H=class extends u.PluginSettingTab{constructor(p,e){super(p,e),this.plugin=e}display(){let{containerEl:p}=this;p.empty(),new u.Setting(p).setName("OpenClaw").setHeading();let e=p.createDiv("openclaw-settings-wizard"),t=e.createDiv("openclaw-settings-wizard-desc");t.createEl("strong",{text:"Setup wizard"}),t.createEl("p",{text:"The easiest way to connect. Walks you through Tailscale, gateway setup, and device pairing step by step.",cls:"setting-item-description"}),e.createEl("button",{text:"Run setup wizard",cls:"mod-cta openclaw-settings-wizard-btn"}).addEventListener("click",()=>{new C(this.app,this.plugin).open()});let n=p.createDiv("openclaw-settings-status"),i=this.plugin.gatewayConnected;n.createSpan({cls:`openclaw-settings-dot ${i?"connected":"disconnected"}`}),n.createSpan({text:i?"Connected":"Disconnected",cls:"openclaw-settings-status-text"}),this.plugin.settings.gatewayUrl&&n.createSpan({text:` \u2014 ${this.plugin.settings.gatewayUrl.replace(/^wss?:\/\//,"")}`,cls:"openclaw-settings-status-url"}),new u.Setting(p).setName("Session").setHeading(),new u.Setting(p).setName("Conversation").setDesc('Current conversation key. Use "main" for the default session.').addText(o=>o.setPlaceholder("Main").setValue(this.plugin.settings.sessionKey).onChange(async a=>{this.plugin.settings.sessionKey=a||"main",await this.plugin.saveSettings()})).addButton(o=>o.setButtonText("Reset to main").onClick(async()=>{this.plugin.settings.sessionKey="main",await this.plugin.saveSettings(),this.display(),await this.plugin.connectGateway(),new u.Notice("Reset to main conversation")})),new u.Setting(p).setName("Connection").setDesc("These are set automatically by the setup wizard. Edit manually only if you know what you're doing.").setHeading(),new u.Setting(p).setName("Gateway URL").setDesc("Tailscale Serve URL (e.g. wss://your-machine.tail1234.ts.net)").addText(o=>o.setPlaceholder("wss://your-machine.tail1234.ts.net").setValue(this.plugin.settings.gatewayUrl).onChange(async a=>{let l=D(a);this.plugin.settings.gatewayUrl=l||a,await this.plugin.saveSettings()})),new u.Setting(p).setName("Auth token").setDesc("Gateway auth token").addText(o=>(o.inputEl.type="password",o.setPlaceholder("Token").setValue(this.plugin.settings.token).onChange(async a=>{this.plugin.settings.token=a,await this.plugin.saveSettings()}))),new u.Setting(p).setName("Reconnect").setDesc("Re-establish the gateway connection").addButton(o=>o.setButtonText("Reconnect").onClick(()=>{this.plugin.connectGateway(),new u.Notice("OpenClaw: Reconnecting...")}))}};
